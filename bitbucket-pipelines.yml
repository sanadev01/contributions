image: atlassian/default-image:2

pipelines:
  branches:
    development:
      - step:
          name: 'Deployment to Staging'
          deployment: staging
          script:
            - pipe: atlassian/ssh-run:0.3.0
              variables:
                  SSH_USER: 'homeqdba'
                  SERVER: '162.0.229.211'
                  MODE: 'script'
                  PORT: '21098'
                  COMMAND: 'deploy-staging.sh'
    master:
      - step:
          name: 'SonarCloud Scan'
          caches:
            - sonar
          script:
            - apt-get update && apt-get install -y openjdk-11-jdk wget
            - wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.7.0.2747-linux.zip
            - unzip sonar-scanner-cli-4.7.0.2747-linux.zip
            - export PATH="$PATH:$PWD/sonar-scanner-4.7.0.2747-linux/bin"
            - sonar-scanner \
                -Dsonar.organization=herco \
                -Dsonar.projectKey=ikonicsolution_hd-v2 \
                -Dsonar.sources=. \
                -Dsonar.host.url=https://sonarcloud.io \
                -Dsonar.login=${SONAR_TOKEN}
            - pipe: sonarsource/sonarcloud-quality-gate:0.1.6
      - step:
          name: 'Deployment to Production'
          deployment: production
          script:
            - pipe: atlassian/ssh-run:0.3.0
              variables:
                  SSH_USER: 'homeqdba'
                  SERVER: '164.90.255.76'
                  MODE: 'script'
                  COMMAND: 'deploy-production.sh'

definitions:
  caches:
    sonar: ~/.sonar/cache

clone:
  depth: full
